---
# Temporary migration job to copy data from safe-nfs to CephFS
# kubectl apply -f kubernetes/_migrations/plex-posters-migration.yaml
# kubectl logs -n media job/migrate-plex-posters -f
# kubectl delete -f kubernetes/_migrations/plex-posters-migration.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: migrate-plex-posters
  namespace: media
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: rsync
          image: instrumentisto/rsync-ssh:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Starting migration: plex-posters â†’ plex-posters-cephfs"
              echo "Source size:"
              du -sh /source
              echo ""
              echo "Starting rsync..."
              rsync -avHP --info=progress2 /source/ /dest/
              echo ""
              echo "Migration complete!"
              echo "Destination size:"
              du -sh /dest
          volumeMounts:
            - name: source
              mountPath: /source
            - name: dest
              mountPath: /dest
      volumes:
        - name: source
          persistentVolumeClaim:
            claimName: plex-posters  # Old safe-nfs PVC
        - name: dest
          persistentVolumeClaim:
            claimName: plex-posters-cephfs  # New CephFS PVC
