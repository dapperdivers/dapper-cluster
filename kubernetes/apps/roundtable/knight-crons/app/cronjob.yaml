---
# Daily CronJobs for the Knights of the Round Table
# Each knight publishes a NATS message at 5:00 AM CST (11:00 UTC) to trigger their daily report.
# Knights: Galahad (security), Kay (research), Bedivere (home),
#          Tristan (infra), Percival (finance), Lancelot (career)
#
# Galahad has day-of-week aware scheduling:
#   Mon: Weekend review (72h lookback)
#   Tue-Thu: Standard daily brief (24h)
#   Fri: Weekly summary with trend analysis
#   Sat-Sun: Light weekend scan (critical-only)
#
# NOTE: $${VAR} syntax is required because Flux postBuild substitutions
# would otherwise consume ${VAR} before the shell sees it.

apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-galahad
  namespace: roundtable
spec:
  schedule: "0 11 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: nats-pub
              image: natsio/nats-box:0.14.5
              command:
                - /bin/sh
                - -c
                - |
                  TODAY=$$(date +%Y-%m-%d)
                  DOW=$$(date +%u)
                  case $$DOW in
                    1) MODE="weekend-review"; DESC="Generate a WEEKEND REVIEW covering the last 72 hours. Focus on attacks launched over the weekend, Friday evening vulnerability dumps, and Monday-morning-relevant advisories. Use your OpenCTI skills to pull recent indicators, CVEs, malware, and reports." ;;
                    5) MODE="weekly-summary"; DESC="Generate a WEEKLY SUMMARY with trend analysis. Review the full week of threat intelligence. Include platform growth stats, top CVEs by severity, most active threat feeds, and whether threat volume is increasing or decreasing. Use your OpenCTI skills." ;;
                    6|7) MODE="weekend-scan"; DESC="WEEKEND SCAN - light touch, critical items only. Quick check of OpenCTI for any critical CVEs or active exploitation. Keep it brief." ;;
                    *) MODE="daily-brief"; DESC="Generate your daily threat intelligence briefing. Cover the last 24 hours of OpenCTI data including new indicators, vulnerabilities, malware, and reports. Use your OpenCTI skills." ;;
                  esac
                  nats pub \
                    --server=nats://nats.database.svc:4222 \
                    "fleet-a.tasks.security.$${MODE}-$${TODAY}-galahad" \
                    "{\"task_id\":\"$${MODE}-$${TODAY}-galahad\",\"domain\":\"security\",\"description\":\"$${DESC} Today is $${TODAY}.\",\"run_id\":\"daily-$${TODAY}\",\"metadata\":{\"type\":\"scheduled\",\"schedule\":\"$${MODE}\"}}"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-kay
  namespace: roundtable
spec:
  schedule: "0 11 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: nats-pub
              image: natsio/nats-box:0.14.5
              command:
                - /bin/sh
                - -c
                - |
                  TODAY=$$(date +%Y-%m-%d)
                  nats pub \
                    --server=nats://nats.database.svc:4222 \
                    "fleet-a.tasks.research.daily-$${TODAY}-kay" \
                    "{\"task_id\":\"daily-$${TODAY}-kay\",\"domain\":\"research\",\"description\":\"Generate your daily report following your report skill template. Today is $${TODAY}.\",\"run_id\":\"daily-$${TODAY}\",\"metadata\":{\"type\":\"scheduled\",\"schedule\":\"daily\"}}"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-bedivere
  namespace: roundtable
spec:
  schedule: "0 11 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: nats-pub
              image: natsio/nats-box:0.14.5
              command:
                - /bin/sh
                - -c
                - |
                  TODAY=$$(date +%Y-%m-%d)
                  nats pub \
                    --server=nats://nats.database.svc:4222 \
                    "fleet-a.tasks.home.daily-$${TODAY}-bedivere" \
                    "{\"task_id\":\"daily-$${TODAY}-bedivere\",\"domain\":\"home\",\"description\":\"Generate your daily report following your report skill template. Today is $${TODAY}.\",\"run_id\":\"daily-$${TODAY}\",\"metadata\":{\"type\":\"scheduled\",\"schedule\":\"daily\"}}"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-tristan
  namespace: roundtable
spec:
  schedule: "0 11 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: nats-pub
              image: natsio/nats-box:0.14.5
              command:
                - /bin/sh
                - -c
                - |
                  TODAY=$$(date +%Y-%m-%d)
                  nats pub \
                    --server=nats://nats.database.svc:4222 \
                    "fleet-a.tasks.infra.daily-$${TODAY}-tristan" \
                    "{\"task_id\":\"daily-$${TODAY}-tristan\",\"domain\":\"infra\",\"description\":\"Generate your daily report following your report skill template. Today is $${TODAY}.\",\"run_id\":\"daily-$${TODAY}\",\"metadata\":{\"type\":\"scheduled\",\"schedule\":\"daily\"}}"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-percival
  namespace: roundtable
spec:
  schedule: "0 11 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: nats-pub
              image: natsio/nats-box:0.14.5
              command:
                - /bin/sh
                - -c
                - |
                  TODAY=$$(date +%Y-%m-%d)
                  nats pub \
                    --server=nats://nats.database.svc:4222 \
                    "fleet-a.tasks.finance.daily-$${TODAY}-percival" \
                    "{\"task_id\":\"daily-$${TODAY}-percival\",\"domain\":\"finance\",\"description\":\"Generate your daily report following your report skill template. Today is $${TODAY}.\",\"run_id\":\"daily-$${TODAY}\",\"metadata\":{\"type\":\"scheduled\",\"schedule\":\"daily\"}}"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-lancelot
  namespace: roundtable
spec:
  schedule: "0 11 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: nats-pub
              image: natsio/nats-box:0.14.5
              command:
                - /bin/sh
                - -c
                - |
                  TODAY=$$(date +%Y-%m-%d)
                  nats pub \
                    --server=nats://nats.database.svc:4222 \
                    "fleet-a.tasks.career.daily-$${TODAY}-lancelot" \
                    "{\"task_id\":\"daily-$${TODAY}-lancelot\",\"domain\":\"career\",\"description\":\"Generate your daily report following your report skill template. Today is $${TODAY}.\",\"run_id\":\"daily-$${TODAY}\",\"metadata\":{\"type\":\"scheduled\",\"schedule\":\"daily\"}}"
# Morning Intel CronJobs REMOVED
# Solar weather, nerd news, and homelab checks are already covered by
# Kay's daily-intel-digest and Tristan's daily-ops-report skills.
# Consolidating to avoid duplicate knight tasks.
