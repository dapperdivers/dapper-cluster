---
# Job to generate random passwords for Wazuh
# Runs once, creates a secret that PushSecret syncs to Infisical
apiVersion: batch/v1
kind: Job
metadata:
  name: wazuh-password-generator
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: wazuh-secret-creator
      containers:
        - name: generator
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              # Check if secret already exists
              if kubectl get secret wazuh-generated-passwords -n security 2>/dev/null; then
                echo "Secret already exists, skipping generation"
                exit 0
              fi
              
              # Generate random passwords
              INDEXER_PASS=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 24)
              API_PASS=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 24)
              DASHBOARD_PASS=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 24)
              
              # Create the secret
              kubectl create secret generic wazuh-generated-passwords \
                -n security \
                --from-literal=WAZUH_INDEXER_PASSWORD="$INDEXER_PASS" \
                --from-literal=WAZUH_API_PASSWORD="$API_PASS" \
                --from-literal=WAZUH_DASHBOARD_PASSWORD="$DASHBOARD_PASS"
              
              echo "Passwords generated and stored in wazuh-generated-passwords secret"
---
# ServiceAccount for the generator job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wazuh-secret-creator
---
# Role to create secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: wazuh-secret-creator
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: wazuh-secret-creator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: wazuh-secret-creator
subjects:
  - kind: ServiceAccount
    name: wazuh-secret-creator
    namespace: security
