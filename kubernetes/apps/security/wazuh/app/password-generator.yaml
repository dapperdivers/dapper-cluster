---
# Job to generate random passwords for Wazuh
# Runs once, creates a secret that PushSecret syncs to Infisical
apiVersion: batch/v1
kind: Job
metadata:
  name: wazuh-password-generator-v2  # Bumped to regenerate with complex passwords
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: wazuh-secret-creator
      containers:
        - name: generator
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              # Delete old secret if exists (regenerating with complex passwords)
              kubectl delete secret wazuh-generated-passwords -n security 2>/dev/null || true
              echo "Generating new complex passwords..."
              
              # Generate random passwords with complexity (upper, lower, numbers, special)
              # Wazuh requires complex passwords
              gen_pass() {
                # Start with guaranteed complexity chars
                UPPER=$(head -c 10 /dev/urandom | base64 | tr -dc 'A-Z' | head -c 2)
                LOWER=$(head -c 10 /dev/urandom | base64 | tr -dc 'a-z' | head -c 2)
                NUMS=$(head -c 10 /dev/urandom | base64 | tr -dc '0-9' | head -c 2)
                SPECIAL='!@#'
                REST=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 16)
                echo "${UPPER}${LOWER}${NUMS}${SPECIAL}${REST}" | fold -w1 | shuf | tr -d '\n' | head -c 24
              }
              INDEXER_PASS=$(gen_pass)
              API_PASS=$(gen_pass)
              DASHBOARD_PASS=$(gen_pass)
              
              # Create the secret
              kubectl create secret generic wazuh-generated-passwords \
                -n security \
                --from-literal=WAZUH_INDEXER_PASSWORD="$INDEXER_PASS" \
                --from-literal=WAZUH_API_PASSWORD="$API_PASS" \
                --from-literal=WAZUH_DASHBOARD_PASSWORD="$DASHBOARD_PASS"
              
              echo "Passwords generated and stored in wazuh-generated-passwords secret"
---
# ServiceAccount for the generator job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wazuh-secret-creator
---
# Role to manage secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: wazuh-secret-creator
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "delete"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: wazuh-secret-creator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: wazuh-secret-creator
subjects:
  - kind: ServiceAccount
    name: wazuh-secret-creator
    namespace: security
