---
# ConfigMap with Wazuh configuration files
# Configured for proper TLS with cert-manager certificates
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-config
data:
  # Indexer config - Full TLS enabled
  opensearch.yml: |
    network.host: 0.0.0.0
    node.name: wazuh-indexer
    cluster.name: wazuh-cluster
    discovery.type: single-node

    # HTTP layer TLS (API access)
    plugins.security.ssl.http.enabled: true
    plugins.security.ssl.http.pemcert_filepath: /usr/share/wazuh-indexer/certs/indexer.pem
    plugins.security.ssl.http.pemkey_filepath: /usr/share/wazuh-indexer/certs/indexer-key.pem
    plugins.security.ssl.http.pemtrustedcas_filepath: /usr/share/wazuh-indexer/certs/root-ca.pem

    # Transport layer TLS (cluster communication)
    plugins.security.ssl.transport.enabled: true
    plugins.security.ssl.transport.pemcert_filepath: /usr/share/wazuh-indexer/certs/indexer.pem
    plugins.security.ssl.transport.pemkey_filepath: /usr/share/wazuh-indexer/certs/indexer-key.pem
    plugins.security.ssl.transport.pemtrustedcas_filepath: /usr/share/wazuh-indexer/certs/root-ca.pem
    plugins.security.ssl.transport.enforce_hostname_verification: false

    # Security configuration
    plugins.security.allow_default_init_securityindex: true
    plugins.security.authcz.admin_dn:
      - "CN=admin,O=Wazuh,OU=Wazuh,L=California,C=US"
    plugins.security.nodes_dn:
      - "CN=wazuh-indexer,O=Wazuh,OU=Wazuh,L=California,C=US"
    plugins.security.restapi.roles_enabled: ["all_access", "security_rest_api_access"]

    # Compatibility
    compatibility.override_main_response_version: true

  # Dashboard config - Full TLS with proper cert paths
  opensearch_dashboards.yml: |
    server.host: 0.0.0.0
    server.port: 5601

    # Dashboard server TLS
    server.ssl.enabled: true
    server.ssl.certificate: /usr/share/wazuh-dashboard/certs/dashboard.pem
    server.ssl.key: /usr/share/wazuh-dashboard/certs/dashboard-key.pem

    # Connection to indexer (TLS)
    opensearch.hosts: https://wazuh-indexer:9200
    opensearch.ssl.verificationMode: certificate
    opensearch.ssl.certificateAuthorities: ["/usr/share/wazuh-dashboard/certs/root-ca.pem"]
    opensearch.username: admin
    opensearch.password: "${INDEXER_PASSWORD}"

    # Security settings
    opensearch.requestHeadersWhitelist: ["securitytenant","Authorization"]
    opensearch_security.multitenancy.enabled: false
    opensearch_security.readonly_mode.roles: ["kibana_read_only"]

    # Default to Wazuh app
    uiSettings.overrides.defaultRoute: /app/wazuh

  # Wazuh app config - API connection settings
  wazuh.yml: |
    hosts:
      - default:
          url: https://wazuh-manager
          port: 55000
          username: wazuh-wui
          password: wazuh-wui
          run_as: false

  # Manager ossec.conf - Core configuration
  ossec.conf: |
    <ossec_config>
      <global>
        <jsonout_output>yes</jsonout_output>
        <alerts_log>yes</alerts_log>
        <logall>no</logall>
        <logall_json>no</logall_json>
        <email_notification>no</email_notification>
      </global>

      <alerts>
        <log_alert_level>3</log_alert_level>
        <email_alert_level>12</email_alert_level>
      </alerts>

      <!-- Indexer output configuration -->
      <indexer>
        <enabled>yes</enabled>
        <hosts>
          <host>https://wazuh-indexer:9200</host>
        </hosts>
        <ssl>
          <certificate_authorities>
            <ca>/etc/ssl/root-ca.pem</ca>
          </certificate_authorities>
          <certificate>/etc/ssl/filebeat.pem</certificate>
          <key>/etc/ssl/filebeat-key.pem</key>
        </ssl>
      </indexer>

      <!-- Vulnerability detection -->
      <vulnerability-detection>
        <enabled>yes</enabled>
        <index-status>yes</index-status>
        <feed-update-interval>60m</feed-update-interval>
      </vulnerability-detection>

      <!-- Log analysis -->
      <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/syslog</location>
      </localfile>

      <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/auth.log</location>
      </localfile>
    </ossec_config>
