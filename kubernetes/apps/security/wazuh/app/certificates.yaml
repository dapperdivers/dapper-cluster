---
# Wazuh PKI - Self-signed CA and component certificates
# This creates a proper certificate chain for internal TLS communication

# Step 1: Create a self-signed CA certificate for Wazuh
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wazuh-ca
spec:
  isCA: true
  commonName: Wazuh Root CA
  secretName: wazuh-ca-secret
  duration: 87600h # 10 years
  renewBefore: 8760h # 1 year
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: self-signed
    kind: ClusterIssuer
    group: cert-manager.io
---
# Step 2: Create an Issuer that uses the CA
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: wazuh-ca-issuer
spec:
  ca:
    secretName: wazuh-ca-secret
---
# Step 3: Indexer certificate (node certificate for cluster communication)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wazuh-indexer-cert
spec:
  secretName: wazuh-indexer-certs
  duration: 8760h # 1 year
  renewBefore: 720h # 30 days
  commonName: wazuh-indexer
  subject:
    organizations:
      - Wazuh
    organizationalUnits:
      - Wazuh
    localities:
      - California
    countries:
      - US
  dnsNames:
    - wazuh-indexer
    - wazuh-indexer.security
    - wazuh-indexer.security.svc
    - wazuh-indexer.security.svc.cluster.local
    - localhost
  ipAddresses:
    - "127.0.0.1"
  usages:
    - digital signature
    - key encipherment
    - server auth
    - client auth
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: wazuh-ca-issuer
    kind: Issuer
    group: cert-manager.io
---
# Step 4: Admin certificate (for indexer administrative operations)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wazuh-admin-cert
spec:
  secretName: wazuh-admin-certs
  duration: 8760h
  renewBefore: 720h
  commonName: admin
  subject:
    organizations:
      - Wazuh
    organizationalUnits:
      - Wazuh
    localities:
      - California
    countries:
      - US
  usages:
    - digital signature
    - key encipherment
    - client auth
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: wazuh-ca-issuer
    kind: Issuer
    group: cert-manager.io
---
# Step 5: Dashboard certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wazuh-dashboard-cert
spec:
  secretName: wazuh-dashboard-certs
  duration: 8760h
  renewBefore: 720h
  commonName: wazuh-dashboard
  subject:
    organizations:
      - Wazuh
    organizationalUnits:
      - Wazuh
    localities:
      - California
    countries:
      - US
  dnsNames:
    - wazuh-dashboard
    - wazuh-dashboard.security
    - wazuh-dashboard.security.svc
    - wazuh-dashboard.security.svc.cluster.local
    - localhost
  ipAddresses:
    - "127.0.0.1"
  usages:
    - digital signature
    - key encipherment
    - server auth
    - client auth
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: wazuh-ca-issuer
    kind: Issuer
    group: cert-manager.io
---
# Step 6: Filebeat certificate (for manager -> indexer communication)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wazuh-filebeat-cert
spec:
  secretName: wazuh-filebeat-certs
  duration: 8760h
  renewBefore: 720h
  commonName: filebeat
  subject:
    organizations:
      - Wazuh
    organizationalUnits:
      - Wazuh
    localities:
      - California
    countries:
      - US
  dnsNames:
    - wazuh-manager
    - wazuh-manager.security
    - wazuh-manager.security.svc
    - wazuh-manager.security.svc.cluster.local
  usages:
    - digital signature
    - key encipherment
    - client auth
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: wazuh-ca-issuer
    kind: Issuer
    group: cert-manager.io
