---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opencti
spec:
  interval: 30m
  chart:
    spec:
      chart: opencti
      version: 0.1.0
      sourceRef:
        kind: HelmRepository
        name: opencti
        namespace: flux-system
      interval: 15m
  maxHistory: 2
  timeout: 15m
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    fullnameOverride: opencti

    # ===================
    # Core OpenCTI Config (auto-propagated to server/workers/connectors)
    # ===================
    opencti:
      adminEmail: admin@chelonianlabs.com
      adminPasswordExistingSecret:
        name: opencti-secrets
        key: OPENCTI_ADMIN_PASSWORD
      adminTokenExistingSecret:
        name: opencti-secrets
        key: OPENCTI_ADMIN_TOKEN
      basePath: "/"
      healthAccessKey: "opencti-health-check-key"
      connectorTokenExistingSecret:
        name: opencti-secrets
        key: OPENCTI_CONNECTOR_TOKEN
      metrics:
        enabled: true

    # ===================
    # Ready Checker
    # ===================
    readyChecker:
      enabled: true
      retries: 60
      timeout: 5

    # ===================
    # Server
    # ===================
    server:
      replicaCount: 1
      nodeOptions: "--max-old-space-size=4096"

      resources:
        requests:
          cpu: 1000m
          memory: 2Gi
        limits:
          memory: 4Gi

      ingress:
        enabled: true
        className: internal-nginx
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-production
        hosts:
          - host: opencti.chelonianlabs.com
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - opencti.chelonianlabs.com
            secretName: opencti-tls

    # ===================
    # Workers
    # ===================
    worker:
      enabled: true
      replicaCount: 3
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          memory: 1Gi

    # ===================
    # External Redis â€” Dragonfly in database namespace
    # ===================
    externalRedis:
      enabled: true
      hostname: dragonfly.database.svc.cluster.local
      port: 6379
      mode: single

    # ===================
    # OpenSearch subchart
    # ===================
    opensearch:
      enabled: true
      replicas: 1
      opensearchJavaOpts: "-Xms2g -Xmx2g"
      resources:
        requests:
          cpu: 1000m
          memory: 4Gi
        limits:
          memory: 4Gi
      persistence:
        enabled: true
        size: 100Gi
        storageClass: ceph-rbd
      securityConfig:
        enabled: false
      config:
        opensearch.yml: |
          cluster.name: opencti
          network.host: 0.0.0.0
          plugins.security.disabled: true

    # ===================
    # RabbitMQ subchart
    # ===================
    global:
      security:
        allowInsecureImages: true

    rabbitmq:
      enabled: true
      image:
        registry: docker.io
        repository: bitnamilegacy/rabbitmq
      auth:
        username: user
        password: ChangeMe
      persistence:
        enabled: true
        size: 10Gi
        storageClass: ceph-rbd
      resources:
        requests:
          cpu: 250m
          memory: 1Gi
        limits:
          memory: 1Gi

    # ===================
    # MinIO subchart
    # ===================
    minio:
      enabled: true
      persistence:
        enabled: true
        size: 20Gi
        storageClass: ceph-rbd
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 512Mi

    # ===================
    # Connectors
    # ===================
    connectors:
      cisa-kev:
        enabled: true
        image:
          repository: opencti/connector-cisa-known-exploited-vulnerabilities
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "cisa-kev-001"
          CONNECTOR_NAME: "CISA Known Exploited Vulnerabilities"
          CONNECTOR_SCOPE: "cisa"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT24H"
          CONNECTOR_CONFIDENCE_LEVEL: "100"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi

      cve:
        enabled: true
        image:
          repository: opencti/connector-cve
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "cve-001"
          CONNECTOR_NAME: "Common Vulnerabilities and Exposures"
          CONNECTOR_SCOPE: "identity,vulnerability"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT24H"
          CONNECTOR_CONFIDENCE_LEVEL: "75"
          CVE__NVD_DATA_FEED: "https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-recent.json.gz"
        envFromSecrets:
          CVE_API_KEY:
            name: opencti-secrets
            key: OPENCTI_NVD_API_KEY
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi

      mitre:
        enabled: true
        image:
          repository: opencti/connector-mitre
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "mitre-001"
          CONNECTOR_NAME: "MITRE ATT&CK"
          CONNECTOR_SCOPE: "tool,report,malware,identity,campaign,intrusion-set,attack-pattern,course-of-action,x-mitre-data-source,x-mitre-data-component,x-mitre-matrix,x-mitre-tactic,x-mitre-collection"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "P7D"
          CONNECTOR_CONFIDENCE_LEVEL: "75"
          MITRE_ENTERPRISE_FILE_URL: "https://raw.githubusercontent.com/mitre/cti/master/enterprise-attack/enterprise-attack.json"
          MITRE_ICS_FILE_URL: "https://raw.githubusercontent.com/mitre/cti/master/ics-attack/ics-attack.json"
          MITRE_MOBILE_FILE_URL: "https://raw.githubusercontent.com/mitre/cti/master/mobile-attack/mobile-attack.json"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi

      epss:
        enabled: true
        image:
          repository: opencti/connector-first-epss-bulk
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "epss-001"
          CONNECTOR_NAME: "FIRST EPSS"
          CONNECTOR_SCOPE: "vulnerability"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT24H"
          CONNECTOR_CONFIDENCE_LEVEL: "75"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi

      urlhaus:
        enabled: true
        image:
          repository: opencti/connector-urlhaus
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "urlhaus-001"
          CONNECTOR_NAME: "URLhaus"
          CONNECTOR_SCOPE: "urlhaus"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT2H"
          CONNECTOR_CONFIDENCE_LEVEL: "40"
          URLHAUS_CSV_URL: "https://urlhaus.abuse.ch/downloads/csv_recent/"
          URLHAUS_IMPORT_OFFLINE: "true"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi

      threatfox:
        enabled: true
        image:
          repository: opencti/connector-threatfox
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "threatfox-001"
          CONNECTOR_NAME: "ThreatFox"
          CONNECTOR_SCOPE: "ThreatFox"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT2H"
          CONNECTOR_CONFIDENCE_LEVEL: "40"
          THREATFOX_CSV_URL: "https://threatfox.abuse.ch/export/csv/recent/"
          THREATFOX_IMPORT_OFFLINE: "true"
          THREATFOX_CREATE_INDICATORS: "true"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi

      # DEPRECATED: abuse.ch SSL blacklist deprecated 2025-01-03
      abuse-ssl:
        enabled: false
        image:
          repository: opencti/connector-abuse-ssl
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "abuse-ssl-001"
          CONNECTOR_NAME: "Abuse.ch SSL Blacklist"
          CONNECTOR_SCOPE: "abusessl"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT2H"
          CONNECTOR_CONFIDENCE_LEVEL: "40"
          ABUSESSL_URL: "https://sslbl.abuse.ch/blacklist/sslblacklist.csv"

      malwarebazaar:
        enabled: true
        image:
          repository: opencti/connector-malwarebazaar-recent-additions
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "malwarebazaar-001"
          CONNECTOR_NAME: "Malware Bazaar Recent Additions"
          CONNECTOR_SCOPE: "malwarebazaar"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT2H"
          CONNECTOR_CONFIDENCE_LEVEL: "50"
          MALWAREBAZAAR_RECENT_ADDITIONS_API_URL: "https://mb-api.abuse.ch/api/v1/"
        envFromSecrets:
          MALWAREBAZAAR_RECENT_ADDITIONS_API_KEY:
            name: opencti-secrets
            key: OPENCTI_MALWAREBAZAAR_API_KEY
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi

      alienvault:
        enabled: true
        image:
          repository: opencti/connector-alienvault
          tag: "6.9.16"
        env:
          CONNECTOR_ID: "alienvault-001"
          CONNECTOR_NAME: "AlienVault OTX"
          CONNECTOR_SCOPE: "alienvault"
          CONNECTOR_LOG_LEVEL: "info"
          CONNECTOR_DURATION_PERIOD: "PT6H"
          CONNECTOR_CONFIDENCE_LEVEL: "50"
          ALIENVAULT_BASE_URL: "https://otx.alienvault.com"
          ALIENVAULT_TLP: "White"
          ALIENVAULT_CREATE_OBSERVABLES: "true"
          ALIENVAULT_CREATE_INDICATORS: "true"
          ALIENVAULT_PULSE_START_TIMESTAMP: "2024-01-01T00:00:00"
          ALIENVAULT_REPORT_TYPE: "threat-report"
          ALIENVAULT_REPORT_STATUS: "New"
          ALIENVAULT_GUESS_MALWARE: "false"
          ALIENVAULT_GUESS_CVE: "false"
          ALIENVAULT_EXCLUDED_PULSE_INDICATOR_TYPES: "FileHash-MD5,FileHash-SHA1"
          ALIENVAULT_INTERVAL: "6"
        envFromSecrets:
          ALIENVAULT_API_KEY:
            name: opencti-secrets
            key: OPENCTI_ALIENVAULT_API_KEY
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi
