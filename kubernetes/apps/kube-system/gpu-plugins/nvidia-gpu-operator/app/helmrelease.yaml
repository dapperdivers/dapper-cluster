---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nvidia-gpu-operator
  namespace: kube-system
spec:
  interval: 30m
  chart:
    spec:
      chart: gpu-operator
      version: v24.9.2
      sourceRef:
        kind: HelmRepository
        name: nvidia-gpu-operator
        namespace: flux-system
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: node-feature-discovery
      namespace: kube-system
  values:
    # Disable components that are already installed
    nfd:
      enabled: false  # We already have node-feature-discovery

    # Driver configuration for Talos
    driver:
      enabled: true  # Required for validation to pass
      usePrecompiled: true  # Use pre-installed driver from Talos
      version: "535.230.02"  # Match Talos extension version

    # Toolkit configuration
    toolkit:
      enabled: true
      version: v1.17.3-ubi8

    # Device plugin configuration with time-slicing
    devicePlugin:
      enabled: true
      config:
        default: |
          version: v1
          flags:
            migStrategy: none
          sharing:
            timeSlicing:
              renameByDefault: false
              failRequestsGreaterThanOne: false
              resources:
                - name: nvidia.com/gpu
                  replicas: 6

    # Container runtime configuration
    operator:
      defaultRuntime: containerd

    # Node configuration for pre-installed driver
    node:
      labels:
        nvidia.com/gpu.deploy.driver: "false"  # Don't deploy driver
        nvidia.com/gpu.deploy.container-toolkit: "true"
        nvidia.com/gpu.deploy.device-plugin: "true"
        nvidia.com/gpu.deploy.dcgm: "true"
        nvidia.com/gpu.deploy.dcgm-exporter: "true"
        nvidia.com/gpu.deploy.gpu-feature-discovery: "true"
        nvidia.com/gpu.deploy.node-status-exporter: "true"
        nvidia.com/gpu.deploy.operator-validator: "true"

    # DCGM for monitoring
    dcgm:
      enabled: true

    # DCGM Exporter for Prometheus metrics
    dcgmExporter:
      enabled: true
      serviceMonitor:
        enabled: true

    # GPU Feature Discovery
    gfd:
      enabled: true

    # MIG Manager (disabled as P100 doesn't support MIG)
    migManager:
      enabled: false

    # Node status exporter
    nodeStatusExporter:
      enabled: true

    # Validator to ensure everything is working
    validator:
      driver:
        env:
          - name: DISABLE_VGPU_VERSION_CHECK
            value: "true"
          - name: DRIVER_TYPE
            value: "pre-installed"
