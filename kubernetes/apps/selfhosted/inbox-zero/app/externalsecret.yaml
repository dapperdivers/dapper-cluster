---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: inbox-zero
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: inbox-zero-secret
    template:
      engineVersion: v2
      mergePolicy: Replace
      data:
        # Database
        DATABASE_URL: "postgresql://{{ .INBOX_ZERO_POSTGRES_USER }}:{{ .INBOX_ZERO_POSTGRES_PASSWORD }}@{{ .POSTGRES_SUPER_HOST_RW }}.database.svc.cluster.local:5432/inboxzero?schema=public"
        DIRECT_URL: "postgresql://{{ .INBOX_ZERO_POSTGRES_USER }}:{{ .INBOX_ZERO_POSTGRES_PASSWORD }}@{{ .POSTGRES_SUPER_HOST_RW }}.database.svc.cluster.local:5432/inboxzero?schema=public"
        # Redis (via serverless-redis-http sidecar)
        UPSTASH_REDIS_URL: "http://localhost:8079"
        UPSTASH_REDIS_TOKEN: "{{ .INBOX_ZERO_REDIS_TOKEN }}"
        # Auth & Encryption
        AUTH_SECRET: "{{ .INBOX_ZERO_AUTH_SECRET }}"
        EMAIL_ENCRYPT_SECRET: "{{ .INBOX_ZERO_ENCRYPT_SECRET }}"
        EMAIL_ENCRYPT_SALT: "{{ .INBOX_ZERO_ENCRYPT_SALT }}"
        INTERNAL_API_KEY: "{{ .INBOX_ZERO_INTERNAL_API_KEY }}"
        API_KEY_SALT: "{{ .INBOX_ZERO_API_KEY_SALT }}"
        CRON_SECRET: "{{ .INBOX_ZERO_CRON_SECRET }}"
        # Google OAuth
        GOOGLE_CLIENT_ID: "{{ .INBOX_ZERO_GOOGLE_CLIENT_ID }}"
        GOOGLE_CLIENT_SECRET: "{{ .INBOX_ZERO_GOOGLE_CLIENT_SECRET }}"
        GOOGLE_PUBSUB_TOPIC_NAME: "{{ .INBOX_ZERO_GOOGLE_PUBSUB_TOPIC }}"
        GOOGLE_PUBSUB_VERIFICATION_TOKEN: "{{ .INBOX_ZERO_GOOGLE_PUBSUB_TOKEN }}"
        # Microsoft OAuth
        MICROSOFT_CLIENT_ID: "{{ .INBOX_ZERO_MICROSOFT_CLIENT_ID }}"
        MICROSOFT_CLIENT_SECRET: "{{ .INBOX_ZERO_MICROSOFT_CLIENT_SECRET }}"
        MICROSOFT_WEBHOOK_CLIENT_STATE: "{{ .INBOX_ZERO_MICROSOFT_WEBHOOK_STATE }}"
        # LLM â€” Anthropic
        DEFAULT_LLM_PROVIDER: "anthropic"
        DEFAULT_LLM_MODEL: "claude-sonnet-4-5-20250929"
        ECONOMY_LLM_PROVIDER: "anthropic"
        ECONOMY_LLM_MODEL: "claude-haiku-4-5-20251001"
        ANTHROPIC_API_KEY: "{{ .INBOX_ZERO_ANTHROPIC_API_KEY }}"
  dataFrom:
    - find:
        name:
          regexp: ^INBOX_ZERO.*
    - find:
        path: POSTGRES_SUPER_HOST_RW
    - sourceRef:
        storeRef:
          name: infisical-postgres
          kind: ClusterSecretStore
      find:
        name:
          regexp: ^INBOX_ZERO_POSTGRES.*

---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: inbox-zero-postgres
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical-postgres
  target:
    name: inbox-zero-postgres-secret
    template:
      engineVersion: v2
      data:
        INIT_POSTGRES_DBNAME: inboxzero
        INIT_POSTGRES_HOST: "{{ .POSTGRES_SUPER_HOST_RW }}.database.svc.cluster.local"
        INIT_POSTGRES_USER: "{{ .INBOX_ZERO_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: "{{ .INBOX_ZERO_POSTGRES_PASSWORD }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
        INIT_POSTGRES_SUPER_USER: "{{ .POSTGRES_SUPER_USER }}"
  dataFrom:
    - find:
        name:
          regexp: ^INBOX_ZERO.*
    - find:
        path: POSTGRES_SUPER_USER
    - find:
        path: POSTGRES_SUPER_PASS
    - find:
        path: POSTGRES_SUPER_HOST_RW
