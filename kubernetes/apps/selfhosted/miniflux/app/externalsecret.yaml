---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: miniflux
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: miniflux-secret
    template:
      engineVersion: v2
      data:
        # Application-specific secrets
        ADMIN_PASSWORD: "{{ .MINIFLUX_ADMIN_PASSWORD }}"

        # Database URL for the application to use
        # Note: postgres-init creates the user/db, app connects with these credentials
        DATABASE_URL: "postgres://{{ .MINIFLUX_POSTGRES_USER }}:{{ .MINIFLUX_POSTGRES_PASSWORD }}@postgres-rw.database.svc.cluster.local:5432/miniflux?sslmode=disable"
  dataFrom:
    - find:
        name:
          regexp: ^MINIFLUX.*

---
# NOTE: The postgres-init ExternalSecret is AUTO-GENERATED by Kyverno!
# You do NOT need to create miniflux-postgres-init ExternalSecret manually.
# Kyverno's postgres-init-externalsecret policy generates it automatically
# based on the annotations in the HelmRelease above.
#
# The auto-generated secret will contain:
#   INIT_POSTGRES_HOST: postgres-rw.database.svc.cluster.local
#   INIT_POSTGRES_SUPER_USER: {{ .POSTGRES_SUPER_USER }}
#   INIT_POSTGRES_SUPER_PASS: {{ .POSTGRES_SUPER_PASS }}
#   INIT_POSTGRES_PORT: 5432
#   INIT_POSTGRES_DBNAME: miniflux
#   INIT_POSTGRES_USER: {{ .MINIFLUX_POSTGRES_USER }}
#   INIT_POSTGRES_PASS: {{ .MINIFLUX_POSTGRES_PASSWORD }}
