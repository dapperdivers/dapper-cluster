---
apiVersion: v1
kind: ConfigMap
metadata:
  name: supabase-init-sql
  namespace: database
data:
  init-supabase.sql: |
    -- Create Supabase schemas
    CREATE SCHEMA IF NOT EXISTS auth;
    CREATE SCHEMA IF NOT EXISTS storage;
    CREATE SCHEMA IF NOT EXISTS realtime;
    CREATE SCHEMA IF NOT EXISTS _realtime;
    CREATE SCHEMA IF NOT EXISTS _analytics;
    CREATE SCHEMA IF NOT EXISTS graphql_public;

    -- Create Supabase roles if they don't exist
    CREATE ROLE anon NOLOGIN;
    CREATE ROLE authenticated NOLOGIN;
    CREATE ROLE service_role NOLOGIN;
    CREATE ROLE authenticator LOGIN;

    -- Grant role memberships
    GRANT anon TO authenticator;
    GRANT authenticated TO authenticator;
    GRANT service_role TO authenticator;

    -- Grant schema usage permissions
    GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;
    GRANT USAGE ON SCHEMA auth TO anon, authenticated, service_role;
    GRANT USAGE ON SCHEMA storage TO anon, authenticated, service_role;
    GRANT USAGE ON SCHEMA realtime TO anon, authenticated, service_role;
    GRANT USAGE ON SCHEMA _realtime TO anon, authenticated, service_role;
    GRANT USAGE ON SCHEMA _analytics TO anon, authenticated, service_role;
    GRANT USAGE ON SCHEMA graphql_public TO anon, authenticated, service_role;

    -- Grant all privileges on all tables (for future tables)
    GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated, service_role;
    GRANT ALL ON ALL TABLES IN SCHEMA auth TO anon, authenticated, service_role;
    GRANT ALL ON ALL TABLES IN SCHEMA storage TO anon, authenticated, service_role;
    GRANT ALL ON ALL TABLES IN SCHEMA realtime TO anon, authenticated, service_role;
    GRANT ALL ON ALL TABLES IN SCHEMA _realtime TO anon, authenticated, service_role;
    GRANT ALL ON ALL TABLES IN SCHEMA _analytics TO anon, authenticated, service_role;
    GRANT ALL ON ALL TABLES IN SCHEMA graphql_public TO anon, authenticated, service_role;

    -- Grant all privileges on all sequences
    GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated, service_role;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA auth TO anon, authenticated, service_role;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA storage TO anon, authenticated, service_role;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA realtime TO anon, authenticated, service_role;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA _realtime TO anon, authenticated, service_role;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA _analytics TO anon, authenticated, service_role;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA graphql_public TO anon, authenticated, service_role;

    -- Grant all privileges on all functions
    GRANT ALL ON ALL ROUTINES IN SCHEMA public TO anon, authenticated, service_role;
    GRANT ALL ON ALL ROUTINES IN SCHEMA auth TO anon, authenticated, service_role;
    GRANT ALL ON ALL ROUTINES IN SCHEMA storage TO anon, authenticated, service_role;
    GRANT ALL ON ALL ROUTINES IN SCHEMA realtime TO anon, authenticated, service_role;
    GRANT ALL ON ALL ROUTINES IN SCHEMA _realtime TO anon, authenticated, service_role;
    GRANT ALL ON ALL ROUTINES IN SCHEMA _analytics TO anon, authenticated, service_role;
    GRANT ALL ON ALL ROUTINES IN SCHEMA graphql_public TO anon, authenticated, service_role;

    -- Set default privileges for future objects
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA auth GRANT ALL ON TABLES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA storage GRANT ALL ON TABLES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA realtime GRANT ALL ON TABLES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA _realtime GRANT ALL ON TABLES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA _analytics GRANT ALL ON TABLES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA graphql_public GRANT ALL ON TABLES TO anon, authenticated, service_role;

    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA auth GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA storage GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA realtime GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA _realtime GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA _analytics GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA graphql_public GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;

    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON ROUTINES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA auth GRANT ALL ON ROUTINES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA storage GRANT ALL ON ROUTINES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA realtime GRANT ALL ON ROUTINES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA _realtime GRANT ALL ON ROUTINES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA _analytics GRANT ALL ON ROUTINES TO anon, authenticated, service_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA graphql_public GRANT ALL ON ROUTINES TO anon, authenticated, service_role;

    -- Install required extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Supabase will create its own auth tables, types and enums during migration

    -- Log completion
    SELECT 'Supabase basic setup completed successfully' AS status;
