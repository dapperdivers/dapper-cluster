---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: supabase
  namespace: database
spec:
  refreshInterval: 5m
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: supabase-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Database connection
        POSTGRES_HOST: "postgres16-rw.database.svc.cluster.local"
        POSTGRES_PORT: "5432"
        POSTGRES_DB: "archon"
        POSTGRES_USER: "gutter"
        POSTGRES_PASSWORD: "{{ .ARCHON_POSTGRES_PASS }}"
        POSTGRES_SCHEMA: "public"
        
        # Database URLs for different services
        DATABASE_URL: "postgres://gutter:{{ .ARCHON_POSTGRES_PASS }}@postgres16-rw.database.svc.cluster.local:5432/archon"
        GOTRUE_DB_DATABASE_URL: "postgres://gutter:{{ .ARCHON_POSTGRES_PASS }}@postgres16-rw.database.svc.cluster.local:5432/archon"
        PGRST_DB_URI: "postgres://gutter:{{ .ARCHON_POSTGRES_PASS }}@postgres16-rw.database.svc.cluster.local:5432/archon"
        
        # JWT Secret (32+ characters)
        JWT_SECRET: "{{ .SUPABASE_JWT_SECRET }}"
        
        # API Keys for Supabase
        ANON_KEY: "{{ .SUPABASE_ANON_KEY }}"
        SERVICE_ROLE_KEY: "{{ .SUPABASE_SERVICE_ROLE_KEY }}"
        
        # Dashboard credentials
        DASHBOARD_USERNAME: "supabase"
        DASHBOARD_PASSWORD: "{{ .SUPABASE_DASHBOARD_PASSWORD }}"
        
        # Auth configuration
        SITE_URL: "https://supabase.${SECRET_DOMAIN}"
        ADDITIONAL_REDIRECT_URLS: "https://archon.${SECRET_DOMAIN}"
        
        # Storage configuration
        STORAGE_BACKEND: "file"
        FILE_SIZE_LIMIT: "52428800"
        
        # SMTP configuration using existing smtp-relay
        SMTP_ADMIN_EMAIL: "supabase@${SECRET_DOMAIN}"
        SMTP_HOST: "smtp-relay.network.svc.cluster.local"
        SMTP_PORT: "25"
        SMTP_USER: "{{ .SMTP_RELAY_USERNAME }}"
        SMTP_PASS: "{{ .SMTP_RELAY_PASSWORD }}"
        SMTP_SENDER_NAME: "Supabase"
        MAILER_URLPATHS_CONFIRMATION: "/auth/v1/verify"
        MAILER_URLPATHS_INVITE: "/auth/v1/verify"
        MAILER_URLPATHS_RECOVERY: "/auth/v1/verify"
        MAILER_URLPATHS_EMAIL_CHANGE: "/auth/v1/verify"
        ENABLE_EMAIL_SIGNUP: "true"
        ENABLE_EMAIL_AUTOCONFIRM: "false"
        ENABLE_PHONE_SIGNUP: "false"
        ENABLE_PHONE_AUTOCONFIRM: "false"

        # Kong Configuration File
        kong.yml: |
          _format_version: "3.0"
          
          services:
            - name: auth-v1-open
              url: http://localhost:9999
              routes:
                - name: auth-v1-open
                  strip_path: true
                  paths:
                    - /auth/v1/verify
                    - /auth/v1/callback  
                    - /auth/v1/authorize
              plugins:
                - name: cors

            - name: auth-v1
              _comment: "GoTrue: /auth/v1/* -> http://localhost:9999/*"
              url: http://localhost:9999
              routes:
                - name: auth-v1-all
                  strip_path: true
                  paths:
                    - /auth/v1/
              plugins:
                - name: cors
                - name: key-auth
                  config:
                    hide_credentials: false
                - name: acl
                  config:
                    hide_groups_header: true

            - name: rest-v1
              _comment: "PostgREST: /rest/v1/* -> http://localhost:3000/*"
              url: http://localhost:3000
              routes:
                - name: rest-v1-all
                  strip_path: true
                  paths:
                    - /rest/v1/
              plugins:
                - name: cors
                - name: key-auth
                  config:
                    hide_credentials: false
                - name: acl
                  config:
                    hide_groups_header: true

            - name: realtime-v1
              _comment: "Realtime: /realtime/v1/* -> ws://localhost:4000/socket/*"
              url: http://localhost:4000/socket
              routes:
                - name: realtime-v1-all
                  strip_path: true
                  paths:
                    - /realtime/v1/
              plugins:
                - name: cors
                - name: key-auth
                  config:
                    hide_credentials: false
                - name: acl
                  config:
                    hide_groups_header: true

            - name: storage-v1
              _comment: "Storage: /storage/v1/* -> http://localhost:5000/*"
              url: http://localhost:5000
              routes:
                - name: storage-v1-all
                  strip_path: true
                  paths:
                    - /storage/v1/
              plugins:
                - name: cors
                - name: key-auth
                  config:
                    hide_credentials: false
                - name: acl
                  config:
                    hide_groups_header: true

          consumers:
            - username: anon
              keyauth_credentials:
                - key: "{{ .SUPABASE_ANON_KEY }}"
              acls:
                - group: anon

            - username: service_role
              keyauth_credentials:
                - key: "{{ .SUPABASE_SERVICE_KEY }}"
              acls:
                - group: admin

          plugins:
            - name: cors
              config:
                origins:
                  - "*"
                methods:
                  - GET
                  - HEAD
                  - PUT
                  - PATCH
                  - POST
                  - DELETE
                  - OPTIONS
                headers:
                  - Accept
                  - Accept-Version
                  - Content-Length
                  - Content-MD5
                  - Content-Type
                  - Date
                  - X-Auth-Token
                  - Authorization
                  - X-Authorization
                  - apikey
                  - prefer
                  - x-client-info
                exposed_headers:
                  - X-Request-Id
                credentials: true
                max_age: 3600

  dataFrom:
    - find:
        name:
          regexp: ^ARCHON.*
    - find:
        name:
          regexp: ^SUPABASE.*
    - find:
        name:
          regexp: ^SMTP_RELAY.*