---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: migrate-job-parallel
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    disableWait: true
    remediation:
      retries: 3
  upgrade:
    disableWait: true
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3

  values:
    controllers:
      migrate-job-parallel:
        type: job
        annotations:
          reloader.stakater.com/auto: "true"
        job:
          # ============================================================
          # CONFIGURATION - Modify these before deploying:
          # ============================================================
          # parallelism: Number of concurrent pods (3-5 recommended)
          # completions: Number of letters to process (26 for A-Z)
          # PARALLEL_JOBS: Concurrent transfers per pod (2-4 recommended)
          #
          # Total concurrency = parallelism × PARALLEL_JOBS
          # Current: 5 pods × 3 jobs = 15 concurrent transfers
          #
          # Monitor tower load before increasing further
          # ============================================================
          completions: 27
          parallelism: 5
          completionMode: Indexed
          ttlSecondsAfterFinished: 86400
        containers:
          app:
            image:
              repository: debian
              tag: bookworm-slim
            command:
              - /bin/bash
              - -c
              - |
                apt-get update -qq && apt-get install -y -qq rsync
                exec /bin/bash /scripts/migrate.sh
            env:
              TZ: ${TIME_ZONE}
              DRY_RUN: false
              SOURCE: /tower/tv/tv_shows
              DEST: /destination/tv/
              PARALLEL_JOBS: "3"
            resources:
              requests:
                cpu: 2000m   # Increased for parallel processing
                memory: 4Gi  # Increased for multiple rsync processes + TV show file counts
              limits:
                cpu: 4       # Allow bursting for parallel transfers
                memory: 8Gi
            securityContext:
              readOnlyRootFilesystem: false
              capabilities:
                add: ["CHOWN", "SETUID", "SETGID"]  # Needed for apt-get and chown operations
            probes:
              liveness:
                enabled: false  # Disabled - large file transfers exceed timeout
          log-tailer:
            image:
              repository: busybox
              tag: "1.37"
            command:
              - /bin/sh
              - -c
              - |
                INDEX=$JOB_COMPLETION_INDEX

                # Convert index to letter (0-25=A-Z, 26=nonalpha)
                if [ "$INDEX" -eq 26 ]; then
                  LETTER="nonalpha"
                else
                  LETTER=$(printf "\\$(printf '%03o' $((65 + INDEX)))")
                fi
                LOG_FILE="/metrics/migration-$LETTER.log"

                echo "[log-tailer] Job Index: $INDEX, Letter: $LETTER"
                echo "[log-tailer] Waiting for log file: $LOG_FILE"

                for i in $(seq 1 60); do
                  if [ -f "$LOG_FILE" ]; then
                    echo "[log-tailer] Found log file, starting tail..."
                    break
                  fi
                  sleep 5
                done

                if [ ! -f "$LOG_FILE" ]; then
                  echo "[log-tailer] ERROR: Log file not created after 5 minutes: $LOG_FILE"
                  exit 1
                fi

                tail -F "$LOG_FILE" &
                TAIL_PID=$!

                echo "[log-tailer] Monitoring main container process..."

                while true; do
                  # Check if app container's bash process is still running
                  # Use [m] trick to avoid matching the grep itself
                  if ! ps aux | grep -q "[m]igrate.sh"; then
                    echo "[log-tailer] Main container process finished. Exiting..."
                    kill $TAIL_PID 2>/dev/null
                    sleep 2
                    exit 0
                  fi
                  sleep 5
                done
            env:
              JOB_COMPLETION_INDEX:
                fieldRef:
                  fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                cpu: 50m
                memory: 64Mi

    defaultPodOptions:
      shareProcessNamespace: true  # Allow log-tailer to see main container's processes
      affinity:
        podAntiAffinity:
          # Prefer not to run on same node as media apps (soft rule - won't block them)
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - plex
                        - tautulli
                        - overseerr
                        - radarr-uhd
                        - radarr
                        - sonarr-uhd
                        - sonarr
                        - tdarr
                        - sabnzbd
                topologyKey: kubernetes.io/hostname
            # Spread migrate jobs across different nodes
            - weight: 50
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - migrate-job-parallel
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsUser: 0  # Root for migration job (needs chown privileges)
        runAsNonRoot: false
        fsGroup: 150
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }

    persistence:
      # ============================================================
      # CONFIGURATION - Update PVC names and mount paths as needed:
      # ============================================================
      nfs-tower:
        existingClaim: media-tower-direct-pvc
        globalMounts:
          - path: /tower
            readOnly: false
      ceph-dest:
        existingClaim: media-cephfs-pvc
        globalMounts:
          - path: /destination
      # ============================================================
      # Metrics PVC - Shared across all workers (DO NOT CHANGE)
      # Contains checkpoint files and logs for resume capability
      # ============================================================
      metrics:
        existingClaim: migration-metrics
        globalMounts:
          - path: /metrics
      script:
        type: configMap
        name: migrate-movies-parallel-script
        defaultMode: 0555
        globalMounts:
          - path: /scripts
