---
apiVersion: v1
kind: ConfigMap
metadata:
  name: migrate-movies-parallel-script
  namespace: media
data:
  migrate.sh: |
    #!/bin/sh
    set -e

    # Map JOB_COMPLETION_INDEX (0-25) to letter (A-Z)
    INDEX=$${JOB_COMPLETION_INDEX:-0}
    LETTERS="A B C D E F G H I J K L M N O P Q R S T U V W X Y Z"
    LETTER=$$(echo $$LETTERS | cut -d' ' -f$$((INDEX + 1)))

    SOURCE="/tower-2/movies"
    DEST="/destination/movies"
    LOG_FILE="/metrics/migration-$${LETTER}.log"
    BATCH_SIZE=20

    echo "======================================"
    echo "Job Index: $${INDEX}"
    echo "Processing Letter: $${LETTER}"
    echo "Batch Size: $${BATCH_SIZE} folders at a time"
    echo "Started at: $$(date)"
    echo "======================================"

    # Get list of all directories starting with this letter
    echo "[$$(date)] Scanning for directories starting with $${LETTER}..."
    TMPFILE="/tmp/dirs-$${LETTER}.txt"
    find "$${SOURCE}/" -maxdepth 1 -type d -name "$${LETTER}*" | sed "s|$${SOURCE}/||" | sort > $$TMPFILE
    TOTAL_DIRS=$$(wc -l < $$TMPFILE)

    if [ $$TOTAL_DIRS -eq 0 ]; then
        echo "[$$(date)] No directories found for letter $${LETTER}, skipping..."
        rm -f $$TMPFILE
        exit 0
    fi

    echo "[$$(date)] Found $$TOTAL_DIRS directories for letter $${LETTER}"
    total_batches=$$(( (TOTAL_DIRS + BATCH_SIZE - 1) / BATCH_SIZE ))
    echo "[$$(date)] Will process in $$total_batches batches of up to $${BATCH_SIZE} folders each"

    # Process folders one-by-one for resilience (no --delay-updates)
    # If job crashes, only current folder lost (not entire batch)
    batch_num=1
    counter=0

    while IFS= read -r dir_name; do
        # Skip empty lines
        [ -z "$$dir_name" ] && continue

        counter=$$(( counter + 1 ))

        # Print batch header every BATCH_SIZE folders (for organization)
        if [ $$(( (counter - 1) % BATCH_SIZE )) -eq 0 ]; then
            batch_end=$$(( counter + BATCH_SIZE - 1 ))
            [ $$batch_end -gt $$TOTAL_DIRS ] && batch_end=$$TOTAL_DIRS

            echo ""
            echo "======================================"
            echo "[$$(date)] Batch $$batch_num/$$total_batches: Items $$counter-$$batch_end of $$TOTAL_DIRS"
            echo "======================================"
        fi

        # Transfer this folder immediately
        echo "[$$(date)] [$$counter/$$TOTAL_DIRS] Transferring: $$dir_name"

        # Create temp file with just this folder
        echo "./$$dir_name" > "$${TMPFILE}.single"

        # rsync this folder (no --delay-updates for immediate finalization)
        # --chmod/--chown: Set permissions during transfer
        rsync \
            --recursive \
            --relative \
            --links \
            --times \
            --stats \
            --verbose \
            --human-readable \
            --whole-file \
            --chmod=D755,F644 \
            --chown=1000:140 \
            --files-from="$${TMPFILE}.single" \
            --log-file="$${LOG_FILE}" \
            "$${SOURCE}/" \
            "$${DEST}/"

        rsync_exit=$$?
        rm -f "$${TMPFILE}.single"

        if [ $$rsync_exit -ne 0 ]; then
            echo "ERROR: rsync failed for $$dir_name (exit code: $$rsync_exit)"
            rm -f $$TMPFILE
            exit 1
        fi

        echo "[$$(date)] Transfer completed for $$dir_name"

        # Delete source folder immediately after successful transfer
        if [ -d "$${SOURCE}/$$dir_name" ]; then
            echo "[$$(date)] Removing source: $${SOURCE}/$$dir_name"
            if ! rm -rf "$${SOURCE}/$$dir_name" 2>/dev/null; then
                echo "WARNING: Failed to remove $${SOURCE}/$$dir_name"
            else
                echo "[$$(date)] Source removed successfully"
            fi
        fi

        # Increment batch number every BATCH_SIZE folders
        if [ $$(( counter % BATCH_SIZE )) -eq 0 ]; then
            echo "[$$(date)] Batch $$batch_num completed"
            batch_num=$$(( batch_num + 1 ))
        fi

    done < $$TMPFILE

    rm -f $$TMPFILE
    echo ""
    echo "======================================"
    echo "Letter $${LETTER} fully completed at: $$(date)"
    echo "All $$total_batches batches transferred and source cleaned up"
    echo "======================================"

    exit 0
