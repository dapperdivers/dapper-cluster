---
apiVersion: v1
kind: ConfigMap
metadata:
  name: plex-preferences
  namespace: media
data:
  # Butler Maintenance Window
  # Adjusted to 7 AM - 11 AM to run AFTER Kometa (which can take many hours)
  # Schedule: Kometa (01:00-~07:00) -> Plex Butler (07:00-11:00) -> ImageMaid (11:30)
  # Format: PLEX_PREFERENCE_<NAME>="Key=Value"
  PLEX_PREFERENCE_1: "ButlerStartHour=7"
  PLEX_PREFERENCE_2: "ButlerEndHour=11"

  # Database Tasks
  PLEX_PREFERENCE_3: "ButlerTaskBackupDatabase=1"  # Backup every 3 days
  PLEX_PREFERENCE_4: "ButlerTaskOptimizeDatabase=1"  # Optimize weekly
  PLEX_PREFERENCE_5: "ButlerDatabaseBackupPath=/config/Library/Application Support/Plex Media Server/Plug-in Support/Databases/Backups"

  # Cache & Bundle Cleanup
  PLEX_PREFERENCE_6: "ButlerTaskCleanOldBundles=1"  # Clean old bundles weekly
  PLEX_PREFERENCE_7: "ButlerTaskCleanOldCacheFiles=1"  # Clean cache weekly

  # Media Analysis (disable deep analysis to reduce load)
  PLEX_PREFERENCE_8: "ButlerTaskDeepMediaAnalysis=0"  # Disabled - resource intensive
  PLEX_PREFERENCE_9: "ButlerTaskUpgradeMediaAnalysis=0"  # Disabled - let Plex handle automatically

  # Library Refresh (disabled - Kometa already triggers refreshes)
  PLEX_PREFERENCE_10: "ButlerTaskRefreshLocalMedia=0"  # Disabled - Kometa handles this
  PLEX_PREFERENCE_11: "ButlerTaskRefreshLibraries=0"  # Disabled - use manual/Kometa scans
  PLEX_PREFERENCE_12: "ButlerTaskRefreshPeriodicMetadata=0"  # Disabled

  # Additional Butler Tasks
  PLEX_PREFERENCE_13: "ButlerTaskRefreshEpgGuides=0"  # Disabled - no live TV/DVR
  PLEX_PREFERENCE_14: "ButlerTaskGenerateMediaIndexFiles=1"  # Enable - helps with search performance

  # Automatic Library Scanning (for network mounts where inotify doesn't work)
  PLEX_PREFERENCE_15: "scheduledLibraryUpdatesEnabled=1"  # Enable periodic library scans
  PLEX_PREFERENCE_16: "scheduledLibraryUpdateInterval=3600"  # Scan every hour (3600 seconds)
  PLEX_PREFERENCE_17: "fSEventLibraryUpdatesEnabled=1"  # Enable auto-updates (may not work on NFS/CephFS)
  PLEX_PREFERENCE_18: "fSEventLibraryPartialScanEnabled=1"  # Only scan changed folders

  # Network & Remote Access
  PLEX_PREFERENCE_19: "secureConnections=1"  # Preferred (0=disabled, 1=preferred, 2=required)
  PLEX_PREFERENCE_20: "enableIPv6=0"  # Disabled - not using IPv6
  PLEX_PREFERENCE_21: "gdmEnabled=1"  # Enable local network discovery (GDM)

  # DLNA (if you use it for other devices)
  PLEX_PREFERENCE_22: "dlnaEnabled=1"  # Enable DLNA server
  PLEX_PREFERENCE_23: "dlnaReportTimeline=1"  # Report playback timeline to DLNA devices

  # Transcoding
  PLEX_PREFERENCE_24: "transcodeCountLimit=3"  # Max 3 simultaneous transcodes (adjust based on GPU)
  PLEX_PREFERENCE_25: "hardwareAcceleratedCodecs=1"  # Enable GPU transcoding (you have NVIDIA GPUs)
  PLEX_PREFERENCE_26: "transcoderTempDirectory=/transcode"  # Use memory-backed transcode directory

  # Webhooks (useful for automation/notifications)
  PLEX_PREFERENCE_27: "webHooksEnabled=1"  # Enable webhooks for integrations

  # Privacy & Analytics
  PLEX_PREFERENCE_28: "collectUsageData=0"  # Disable sending analytics to Plex (privacy)

  # Transcoding Buffer Optimizations (for smoother transcoded playback)
  PLEX_PREFERENCE_29: "transcoderThrottleBuffer=120"  # Buffer 120s before throttling (default: 60s)
  PLEX_PREFERENCE_30: "transcoderPruneBuffer=600"  # Retain 10min of segments (default: 300s)
  PLEX_PREFERENCE_31: "segmentedTranscoderTimeout=30"  # Wait 30s for transcoder to start (default: 20s)

  # Bandwidth Settings (unlimited - 2.5Gbps uplink)
  PLEX_PREFERENCE_32: "wanPerStreamMaxUploadRate=0"  # Unlimited per-stream bandwidth
  PLEX_PREFERENCE_33: "wanTotalMaxUploadRate=0"  # Unlimited total upload bandwidth
  PLEX_PREFERENCE_34: "wanPerUserStreamCount=0"  # Unlimited streams per user

  # Background Transcoding Quality (for sync/downloads)
  PLEX_PREFERENCE_35: "transcoderH264BackgroundPreset=medium"  # Medium preset (balanced quality/speed)
