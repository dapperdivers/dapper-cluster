---
apiVersion: batch/v1
kind: Job
metadata:
  name: tdarr-patch-immediate
  namespace: media
spec:
  template:
    spec:
      serviceAccountName: tdarr-patcher
      containers:
      - name: patcher
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Starting immediate Tdarr node limit patch..."

          # Wait for Tdarr pod to be ready
          echo "Waiting for Tdarr server pod to be ready..."
          for i in {1..60}; do
            POD=$(kubectl get pods -n media -l app.kubernetes.io/name=tdarr --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
            if [ ! -z "$POD" ]; then
              echo "Found running Tdarr server pod: $POD"
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done

          if [ -z "$POD" ]; then
            echo "No running Tdarr server pod found after 5 minutes, exiting..."
            exit 1
          fi

          # Wait a bit for the server to fully initialize
          echo "Waiting 30 seconds for server to initialize..."
          sleep 30

          # Check if already patched
          if kubectl exec -n media $POD -- grep -q "0x3e7" /app/Tdarr_Server/srcug/api/nodeRelay/nodeRelay.js 2>/dev/null; then
            echo "✅ Already patched!"
            exit 0
          fi

          echo "Applying patch to increase node limit from 5 to 999..."

          # Apply the patch
          kubectl exec -n media $POD -- sed -i 's/>=0x5&&y/>=0x3e7&&y/g' /app/Tdarr_Server/srcug/api/nodeRelay/nodeRelay.js

          # Verify patch was applied
          if kubectl exec -n media $POD -- grep -q "0x3e7" /app/Tdarr_Server/srcug/api/nodeRelay/nodeRelay.js 2>/dev/null; then
            echo "✅ Patch applied successfully!"
            echo "Restarting Tdarr server pod to apply changes..."
            kubectl delete pod -n media $POD
            echo "Pod deletion triggered, server will restart with patch applied"
          else
            echo "❌ Patch failed!"
            exit 1
          fi
      restartPolicy: OnFailure
