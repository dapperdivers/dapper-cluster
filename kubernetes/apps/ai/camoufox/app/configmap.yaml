---
apiVersion: v1
kind: ConfigMap
metadata:
  name: camoufox-server
data:
  server.py: |
    #!/usr/bin/env python3
    """
    Camoufox API Server
    A REST API wrapper around Camoufox for stealth web browsing.
    """

    import asyncio
    import base64
    import os
    import traceback
    from contextlib import asynccontextmanager
    from datetime import datetime
    from typing import Optional

    from fastapi import FastAPI, HTTPException
    from pydantic import BaseModel, Field
    from camoufox.async_api import AsyncCamoufox

    # Configuration
    HOST = os.getenv("HOST", "0.0.0.0")
    PORT = int(os.getenv("PORT", "8080"))
    DEFAULT_TIMEOUT = int(os.getenv("DEFAULT_TIMEOUT", "30000"))
    MAX_CONTENT_LENGTH = int(os.getenv("MAX_CONTENT_LENGTH", "2000000"))

    startup_time = None


    class BrowseRequest(BaseModel):
        url: str
        wait_for: Optional[str] = Field(None, description="CSS selector to wait for")
        wait_timeout: Optional[int] = Field(DEFAULT_TIMEOUT, description="Timeout in ms")
        extract_text: bool = Field(True, description="Extract text content")
        extract_html: bool = Field(False, description="Extract HTML content")
        extract_links: bool = Field(False, description="Extract all links")
        viewport_width: int = Field(1920, description="Viewport width")
        viewport_height: int = Field(1080, description="Viewport height")
        proxy: Optional[dict] = Field(None, description="Proxy configuration")
        headers: Optional[dict] = Field(None, description="Custom headers")
        cookies: Optional[list] = Field(None, description="Cookies to set")


    class ScreenshotRequest(BaseModel):
        url: str
        wait_for: Optional[str] = Field(None, description="CSS selector to wait for")
        wait_timeout: Optional[int] = Field(DEFAULT_TIMEOUT, description="Timeout in ms")
        full_page: bool = Field(False, description="Capture full page")
        viewport_width: int = Field(1920, description="Viewport width")
        viewport_height: int = Field(1080, description="Viewport height")
        quality: int = Field(80, description="Image quality (0-100)")
        format: str = Field("png", description="Image format (png/jpeg)")


    class ExecuteRequest(BaseModel):
        url: str
        script: str = Field(..., description="Python code to execute with 'page' variable")
        wait_timeout: Optional[int] = Field(DEFAULT_TIMEOUT, description="Timeout in ms")
        viewport_width: int = Field(1920, description="Viewport width")
        viewport_height: int = Field(1080, description="Viewport height")


    @asynccontextmanager
    async def lifespan(app: FastAPI):
        global startup_time
        startup_time = datetime.utcnow()
        print(f"Camoufox API server starting at {startup_time.isoformat()}")
        yield
        print("Camoufox API server shutting down")


    app = FastAPI(
        title="Camoufox API",
        description="Stealth browser service powered by Camoufox",
        version="1.0.0",
        lifespan=lifespan
    )


    @app.get("/health")
    async def health():
        return {"status": "healthy", "timestamp": datetime.utcnow().isoformat()}


    @app.get("/status")
    async def status():
        return {
            "status": "running",
            "startup_time": startup_time.isoformat() if startup_time else None,
            "uptime_seconds": (datetime.utcnow() - startup_time).total_seconds() if startup_time else 0,
            "config": {
                "default_timeout": DEFAULT_TIMEOUT,
                "max_content_length": MAX_CONTENT_LENGTH,
            }
        }


    @app.post("/browse")
    async def browse(request: BrowseRequest):
        start_time = datetime.utcnow()

        try:
            camoufox_opts = {"headless": True, "geoip": True}
            if request.proxy:
                camoufox_opts["proxy"] = request.proxy

            async with AsyncCamoufox(**camoufox_opts) as browser:
                page = await browser.new_page()

                await page.set_viewport_size({
                    "width": request.viewport_width,
                    "height": request.viewport_height
                })

                if request.headers:
                    await page.set_extra_http_headers(request.headers)

                if request.cookies:
                    await page.context.add_cookies(request.cookies)

                response = await page.goto(
                    request.url,
                    wait_until="domcontentloaded",
                    timeout=request.wait_timeout
                )

                if request.wait_for:
                    await page.wait_for_selector(request.wait_for, timeout=request.wait_timeout)

                await asyncio.sleep(1)

                title = await page.title()
                final_url = page.url

                text_content = None
                html_content = None
                links = None

                if request.extract_text:
                    text_content = await page.inner_text("body")
                    if len(text_content) > MAX_CONTENT_LENGTH:
                        text_content = text_content[:MAX_CONTENT_LENGTH] + "... [truncated]"

                if request.extract_html:
                    html_content = await page.content()
                    if len(html_content) > MAX_CONTENT_LENGTH:
                        html_content = html_content[:MAX_CONTENT_LENGTH] + "... [truncated]"

                if request.extract_links:
                    links = await page.evaluate("""
                        () => Array.from(document.querySelectorAll('a[href]'))
                            .map(a => ({href: a.href, text: a.innerText.trim()}))
                            .filter(l => l.href.startsWith('http'))
                            .slice(0, 100)
                    """)

                took_ms = int((datetime.utcnow() - start_time).total_seconds() * 1000)

                return {
                    "url": request.url,
                    "final_url": final_url,
                    "title": title,
                    "text": text_content,
                    "html": html_content,
                    "links": links,
                    "status": response.status if response else 0,
                    "took_ms": took_ms
                }

        except Exception as e:
            raise HTTPException(status_code=500, detail={"error": str(e), "traceback": traceback.format_exc()})


    @app.post("/screenshot")
    async def screenshot(request: ScreenshotRequest):
        start_time = datetime.utcnow()

        try:
            async with AsyncCamoufox(headless=True, geoip=True) as browser:
                page = await browser.new_page()

                await page.set_viewport_size({
                    "width": request.viewport_width,
                    "height": request.viewport_height
                })

                await page.goto(request.url, wait_until="domcontentloaded", timeout=request.wait_timeout)

                if request.wait_for:
                    await page.wait_for_selector(request.wait_for, timeout=request.wait_timeout)

                await asyncio.sleep(1)

                screenshot_bytes = await page.screenshot(
                    full_page=request.full_page,
                    type=request.format,
                    quality=request.quality if request.format == "jpeg" else None
                )

                took_ms = int((datetime.utcnow() - start_time).total_seconds() * 1000)

                return {
                    "url": request.url,
                    "image_base64": base64.b64encode(screenshot_bytes).decode(),
                    "format": request.format,
                    "width": request.viewport_width,
                    "height": request.viewport_height,
                    "took_ms": took_ms
                }

        except Exception as e:
            raise HTTPException(status_code=500, detail={"error": str(e), "traceback": traceback.format_exc()})


    @app.post("/execute")
    async def execute(request: ExecuteRequest):
        start_time = datetime.utcnow()

        try:
            async with AsyncCamoufox(headless=True, geoip=True) as browser:
                page = await browser.new_page()

                await page.set_viewport_size({
                    "width": request.viewport_width,
                    "height": request.viewport_height
                })

                await page.goto(request.url, wait_until="domcontentloaded", timeout=request.wait_timeout)

                local_vars = {}
                exec(f"async def __script(page):\n" +
                     "\n".join("    " + line for line in request.script.split("\n")),
                     {"asyncio": asyncio}, local_vars)

                result = await local_vars["__script"](page)

                took_ms = int((datetime.utcnow() - start_time).total_seconds() * 1000)

                return {"url": request.url, "result": result, "took_ms": took_ms}

        except Exception as e:
            raise HTTPException(status_code=500, detail={"error": str(e), "traceback": traceback.format_exc()})


    if __name__ == "__main__":
        import uvicorn
        uvicorn.run(app, host=HOST, port=PORT)
