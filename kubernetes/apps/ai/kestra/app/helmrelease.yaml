---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kestra
spec:
  interval: 30m
  chart:
    spec:
      chart: kestra
      version: 0.21.4
      sourceRef:
        kind: HelmRepository
        name: kestra
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    # Disable bundled dependencies (using external postgres + local PVC)
    postgresql:
      enabled: false
    minio:
      enabled: false

    # Common settings for all deployments
    common:
      # Database init container (runs before main container)
      initContainers:
        - name: init-db
          image: ghcr.io/home-operations/postgres-init:18.1
          envFrom:
            - secretRef:
                name: kestra-postgres-secret
      # Environment from secrets (DB credentials)
      extraEnv:
        - name: DATASOURCES_POSTGRES_URL
          valueFrom:
            secretKeyRef:
              name: kestra-secret
              key: DATASOURCES_POSTGRES_URL
        - name: DATASOURCES_POSTGRES_USERNAME
          valueFrom:
            secretKeyRef:
              name: kestra-secret
              key: DATASOURCES_POSTGRES_USERNAME
        - name: DATASOURCES_POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: kestra-secret
              key: DATASOURCES_POSTGRES_PASSWORD

    # Kestra configuration
    configuration:
      kestra:
        repository:
          type: postgres
        queue:
          type: postgres
        storage:
          type: local
          local:
            basePath: /app/storage

    # Disable Docker-in-Docker (using K8s task runner)
    dind:
      enabled: false

    # Distributed mode - separate deployments
    deployments:
      standalone:
        enabled: false
      webserver:
        enabled: true
      executor:
        enabled: true
      indexer:
        enabled: true
      scheduler:
        enabled: true
      worker:
        enabled: true

    # Persistence for local storage
    persistence:
      enabled: true
      existingClaim: kestra

    # Resources per component
    resources:
      requests:
        cpu: 100m
        memory: 768Mi
      limits:
        memory: 1536Mi

    # Ingress with Authentik
    ingress:
      enabled: true
      className: internal
      annotations:
        external-dns.alpha.kubernetes.io/target: "internal.${SECRET_DOMAIN}"
        authentik.home.arpa/internal: "true"
        nginx.ingress.kubernetes.io/auth-signin: "https://kestra.${SECRET_DOMAIN}/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri"
      hosts:
        - host: &host "kestra.${SECRET_DOMAIN}"
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: ${SECRET_DOMAIN/./-}-tls
          hosts:
            - *host

    # Prometheus metrics
    serviceMonitor:
      enabled: true
