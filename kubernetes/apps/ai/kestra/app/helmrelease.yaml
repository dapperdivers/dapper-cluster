---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kestra
spec:
  interval: 30m
  chart:
    spec:
      chart: kestra
      version: 1.0.28
      sourceRef:
        kind: HelmRepository
        name: kestra
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  # Patch worker deployment (chart bug workarounds)
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: kestra-worker
            patch: |
              - op: add
                path: /spec/template/spec/serviceAccountName
                value: kestra
          # Fix dind to run as root (not rootless)
          - target:
              kind: Deployment
              name: kestra-worker
            patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: kestra-worker
              spec:
                template:
                  spec:
                    containers:
                      - name: kestra-worker-docker-dind
                        securityContext:
                          privileged: true
                          runAsUser: 0
                          runAsGroup: 0
          # Inject secrets as env vars on worker (KESTRA_ prefix exposes to envs.*)
          - target:
              kind: Deployment
              name: kestra-worker
            patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: kestra-worker
              spec:
                template:
                  spec:
                    containers:
                      - name: kestra-worker
                        env:
                          - name: KESTRA_CLAUDE_CODE_OAUTH_TOKEN
                            valueFrom:
                              secretKeyRef:
                                name: kestra-secret
                                key: CLAUDE_CODE_OAUTH_TOKEN
  valuesFrom:
    - kind: Secret
      name: kestra-datasources-secret
      valuesKey: DATASOURCES_POSTGRES_USERNAME
      targetPath: configurations.application.datasources.postgres.username
    - kind: Secret
      name: kestra-datasources-secret
      valuesKey: DATASOURCES_POSTGRES_PASSWORD
      targetPath: configurations.application.datasources.postgres.password
    - kind: Secret
      name: kestra-secret
      valuesKey: CLAUDE_CODE_OAUTH_TOKEN
      targetPath: configurations.application.kestra.variables.globals.CLAUDE_CODE_OAUTH_TOKEN
    - kind: Secret
      name: kestra-secret
      valuesKey: MINIO_ACCESS_KEY
      targetPath: configurations.application.kestra.storage.minio.accessKey
    - kind: Secret
      name: kestra-secret
      valuesKey: MINIO_SECRET_KEY
      targetPath: configurations.application.kestra.storage.minio.secretKey
  values:
    # Use existing service account with RBAC for K8s task runner
    serviceAccount:
      create: false
      name: kestra

    # Kestra configuration (rendered to application.yml)
    # NOTE: configurations.application is required in chart v1.0.0+
    configurations:
      application:
        datasources:
          postgres:
            url: jdbc:postgresql://postgres-rw.database.svc.cluster.local:5432/kestra
            driverClassName: org.postgresql.Driver
        kestra:
          repository:
            type: postgres
          queue:
            type: postgres
          storage:
            type: minio
            minio:
              endpoint: minio.storage.svc.cluster.local
              port: 9000
              secure: false
              bucket: kestra
          plugins:
            configurations:
              - type: io.kestra.plugin.scripts
                values:
                  taskRunner:
                    type: io.kestra.plugin.kubernetes.runner.Kubernetes
                    namespace: ai
                    pullPolicy: IF_NOT_PRESENT

    # Common settings for all deployments
    common:
      # Resources per component
      resources:
        requests:
          cpu: 100m
          memory: 768Mi
        limits:
          memory: 1536Mi
      # Persistence for local storage (using extraVolumes in v1.0.0+)
      extraVolumes:
        - name: storage
          persistentVolumeClaim:
            claimName: kestra
      extraVolumeMounts:
        - name: storage
          mountPath: /app/storage

    # Enable Docker-in-Docker for script task runner
    dind:
      enabled: true
      mode: insecure  # Required for privileged dind (was default in old chart)

    # Distributed mode - separate deployments
    deployments:
      standalone:
        enabled: false
      webserver:
        enabled: true
      executor:
        enabled: true
      indexer:
        enabled: true
      scheduler:
        enabled: true
      worker:
        enabled: true

    # Ingress with Authentik
    ingress:
      enabled: true
      className: internal
      annotations:
        external-dns.alpha.kubernetes.io/target: "internal.${SECRET_DOMAIN}"
        authentik.home.arpa/internal: "true"
        nginx.ingress.kubernetes.io/auth-signin: "https://kestra.${SECRET_DOMAIN}/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri"
      hosts:
        - host: &host "kestra.${SECRET_DOMAIN}"
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: ${SECRET_DOMAIN/./-}-tls
          hosts:
            - *host

    # Prometheus metrics
    serviceMonitor:
      enabled: true
